name: 'Accuknox Semgrep Scan'
description: 'Perform Semgrep scan on your repository and upload the results to Accuknox'

inputs:
  token:
    description: 'The token for authenticating with the CSPM panel.'
    required: true
  tenant_id:
    description: 'The ID of the tenant associated with the CSPM panel.'
    required: true
  label:
    description: 'The label created in AccuKnox SaaS for associating scan results.'
    required: true
  endpoint:
    description: 'The URL of the CSPM panel to push the scan results to.'
    required: true
    default: 'cspm.demo.accuknox.com'
  subcommand:
    description: 'Semgrep subcommand to run (e.g. ci, scan)'
    required: true
    default: 'scan'
  config:
    description: 'Semgrep ruleset or config file'
    required: false
  extra_args:
    description: 'Additional arguments to pass to semgrep'
    required: false
    default: ''
  paths:
    description: 'Paths to scan'
    required: false
    default: '.'

runs:
  using: 'composite'
  steps:
    - name: Run Semgrep
      uses: docker://semgrep/semgrep:latest
      with:
        args: >-
          bash -c "
          semgrep ${{ inputs.subcommand }} \
            --json \
            --output semgrep-results.json \
            ${{ inputs.config != '' && format('--config {0}', inputs.config) || '' }} \
            ${{ inputs.extra_args }} \
            ${{ inputs.paths }}"

    - name: Process Results
      shell: bash
      run: |
        jq -c . semgrep-results.json | \
        jq --arg repo "${{ github.repository }}" \
          --arg sha "${{ github.sha }}" \
          --arg ref "${{ github.ref }}" \
          --arg run_id "${{ github.run_id }}" \
          --arg run_number "${{ github.run_number }}" \
          --arg repo_url "${{ github.server_url }}/${{ github.repository }}" \
          --arg repo_run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
          '. + {
            repo: $repo,
            sha: $sha,
            ref: $ref,
            run_id: $run_id,
            run_number: $run_number,
            repo_url: $repo_url,
            repo_run_url: $repo_run_url,
          }' > results.json

    - name: Extract Code Snippets
      shell: bash
      run: |
        JSON_FILE="results.json"
        TEMP_JSON_FILE="/tmp/semgrep_output_updated.json"
        
        cp "$JSON_FILE" "$TEMP_JSON_FILE"
        
        # Get number of results
        RESULTS_COUNT=$(jq '.results | length' "$JSON_FILE")
        
        # Loop using seq (POSIX-compatible)
        for i in $(seq 0 $(($RESULTS_COUNT - 1))); do
          FILE_PATH=$(jq -r ".results[$i].path" "$JSON_FILE")
          START_LINE=$(jq -r ".results[$i].start.line" "$JSON_FILE")
          END_LINE=$(jq -r ".results[$i].end.line" "$JSON_FILE")
        
          echo "Processing file: $FILE_PATH (Lines: $START_LINE-$END_LINE)"
        
          if [ -f "$FILE_PATH" ]; then
            # Extract the affected code snippet
            CODE_SNIPPET=$(sed -n "${START_LINE},${END_LINE}p" "$FILE_PATH" | jq -R -s .)
        
            # Update JSON with the extracted code
            jq --argjson index "$i" --arg code "$CODE_SNIPPET" \
              '(.results[$index].extra.lines) = $code' \
              "$TEMP_JSON_FILE" > temp.json && mv temp.json "$TEMP_JSON_FILE"
          else
            echo "Warning: File $FILE_PATH not found!"
          fi
        done
        
        mv "$TEMP_JSON_FILE" "$JSON_FILE"

    - name: Push report to CSPM panel
      shell: bash
      run: |
        if [[ ! -s results.json ]]; then
          echo "No Issues found. Skipping API upload."
          exit 0
        fi
        
        RESPONSE=$(curl --location "https://${{ inputs.endpoint }}/api/v1/artifact/?tenant_id=${{ inputs.tenant_id }}&data_type=SG&save_to_s3=true&label_id=${{ inputs.label }}" \
            --header "Tenant-Id: ${{ inputs.tenant_id }}" \
            --header "Authorization: Bearer ${{ inputs.token }}" \
            --form "file=@./results.json")

        echo "Response: $RESPONSE"
        if [[ "$RESPONSE" != *"File received successfully"* ]]; then
          echo "Error: Failed to push report to CSPM panel"
          exit 1
        fi

outputs:
  results-file:
    description: 'Path to the JSON results file'
    value: results.json